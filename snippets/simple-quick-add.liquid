<button
  class="quick-add-simple"
  data-product-handle="{{ product.handle }}"
  aria-label="Add {{ product.title }} to cart"
>
  <span class="quick-add-simple__icon">
    {{ 'icon-add-to-cart.svg' | inline_asset_content }}
  </span>
  <span class="quick-add-simple__text">Add</span>
</button>

<style>
.product-image-slider { position: relative; }

.quick-add-simple {
  position: absolute;
  bottom: 10px;
  right: 10px;
  z-index: 20;
  display: flex;
  align-items: center;
  gap: 6px;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 999px;
  padding: 8px 10px;
  cursor: pointer;
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
  transform: translateY(6px);
  transition: opacity .2s ease, transform .2s ease, background .2s ease;
}

.product-image-slider:hover .quick-add-simple {
  opacity: 1;
  visibility: visible;
  pointer-events: all;
  transform: translateY(0);
}

.quick-add-simple__icon svg { 
  width: 16px; 
  height: 16px;
  transition: transform .2s ease;
}

.quick-add-simple__text {
  font-size: 14px;
  white-space: nowrap;
  max-width: 0;
  overflow: hidden;
  opacity: 0;
  transition: max-width .25s ease, opacity .2s ease;
}

.quick-add-simple:hover .quick-add-simple__text {
  max-width: 50px;
  opacity: 1;
}

.quick-add-simple.adding {
  background: #f0f0f0;
}

.quick-add-simple.adding .quick-add-simple__icon svg {
  animation: spin 0.6s linear infinite;
}

.quick-add-simple.added {
  background: #4caf50;
  border-color: #4caf50;
  color: white;
}

.quick-add-simple.added svg {
  fill: white;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.quick-add-fly {
  position: fixed;
  z-index: 1000;
  transition: transform 0.6s cubic-bezier(0.4,0,0.2,1), opacity 0.6s ease;
  pointer-events: none;
}
</style>

<script>
document.addEventListener('click', async function(e) {
  const button = e.target.closest('.quick-add-simple');
  if (!button) return;

  e.preventDefault();
  e.stopImmediatePropagation();

  if (button.disabled) return;
  button.disabled = true;
  button.classList.add('adding');

  const handle = button.dataset.productHandle;
  if (!handle) return;

  try {
    // Get product JSON
    const productData = await fetch(`/products/${handle}.js`).then(r => r.json());
    const variant = productData.variants.find(v => v.available);
    if (!variant) { 
      button.disabled = false;
      button.classList.remove('adding');
      return;
    }

    // Get product image for animation
    const imgEl = button.closest('.product-image-slider')?.querySelector('img');
    let clone;
    if (imgEl) {
      clone = imgEl.cloneNode(true);
      clone.classList.add('quick-add-fly');
      clone.style.width = imgEl.offsetWidth + 'px';
      clone.style.height = imgEl.offsetHeight + 'px';
      const rect = imgEl.getBoundingClientRect();
      clone.style.top = rect.top + 'px';
      clone.style.left = rect.left + 'px';
      document.body.appendChild(clone);
    }

    // Add to cart
    const addResponse = await fetch('/cart/add.js', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ 
        items: [{
          id: variant.id,
          quantity: 1
        }]
      })
    });

    if (!addResponse.ok) throw new Error('Failed to add to cart');
    const addedItem = await addResponse.json();

    // Animate fly-to-cart
    if (clone) {
      const cartIcon = document.querySelector('.header__icon--cart, .cart-count-bubble, #cart-icon-bubble, [href="/cart"]');
      if (cartIcon) {
        const rect = cartIcon.getBoundingClientRect();
        requestAnimationFrame(() => {
          clone.style.transform = `translate(${rect.left - clone.getBoundingClientRect().left}px, ${rect.top - clone.getBoundingClientRect().top}px) scale(0.2)`;
          clone.style.opacity = '0';
        });
        setTimeout(() => clone.remove(), 600);
      } else {
        clone.remove();
      }
    }

    // Get updated cart data
    const cartResponse = await fetch('/cart.js');
    const cart = await cartResponse.json();

    // Update all possible cart count elements
    const updateCartCount = (count) => {
      // Dawn theme and common selectors
      const selectors = [
        '.cart-count-bubble',
        '#cart-icon-bubble',
        '.header__cart-count',
        '[data-cart-count]',
        '.cart-count',
        'cart-count-bubble',
        '#CartCount',
        '.CartCount'
      ];
      
      selectors.forEach(selector => {
        const elements = document.querySelectorAll(selector);
        elements.forEach(el => {
          // Update text content
          el.textContent = count;
          el.innerText = count;
          
          // Update data attribute if exists
          if (el.hasAttribute('data-cart-count')) {
            el.setAttribute('data-cart-count', count);
          }
          
          // Show/hide based on count
          if (count > 0) {
            el.classList.remove('hidden');
            el.removeAttribute('hidden');
            el.style.display = '';
          } else {
            el.classList.add('hidden');
          }
        });
      });
    };

    // Update the count
    updateCartCount(cart.item_count);

    // Dispatch multiple events for theme compatibility
    const events = [
      new CustomEvent('cart:refresh', { bubbles: true, detail: { cart } }),
      new CustomEvent('cart:updated', { bubbles: true, detail: { cart } }),
      new CustomEvent('cart:change', { bubbles: true, detail: { cart } })
    ];
    
    events.forEach(event => {
      document.documentElement.dispatchEvent(event);
      document.body.dispatchEvent(event);
      document.dispatchEvent(event);
    });

    // Trigger cart drawer/notification
    setTimeout(() => {
      // Try to open cart drawer
      const drawer = document.querySelector('cart-drawer');
      if (drawer && typeof drawer.renderContents === 'function') {
        drawer.renderContents(cart);
      }
      
      // Try cart notification
      const notification = document.querySelector('cart-notification');
      if (notification && typeof notification.renderContents === 'function') {
        notification.renderContents(cart);
      }
      
      // Fallback: click cart icon
      const cartLink = document.querySelector('.header__icon--cart');
      if (cartLink) {
        cartLink.click();
      }
    }, 100);

    // Visual feedback
    button.classList.remove('adding');
    button.classList.add('added');
    
    setTimeout(() => {
      button.classList.remove('added');
      button.disabled = false;
    }, 1500);

  } catch(err) {
    console.error('Quick add failed:', err);
    button.classList.remove('adding');
    button.disabled = false;
    alert('Failed to add product to cart. Please try again.');
  }
});
</script>
