<button
  class="quick-add-simple"
  data-product-handle="{{ product.handle }}"
  aria-label="Add {{ product.title }} to cart"
>
  <span class="quick-add-simple__icon">
    {{ 'quick-add-icon.svg' | inline_asset_content }}
  </span>
  <span class="quick-add-simple__text">quick add</span>
</button>

<style>
.product-image-slider { position: relative; }

.quick-add-simple {
  position: absolute;
  bottom: 10px;
  right: 10px;
  z-index: 20;
  display: flex;
  align-items: center;
  gap: 6px;
  background: #fff;
  padding: 10px;
  border: none;
  cursor: pointer;
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
  transform: translateY(6px);
  transition: opacity .2s ease, transform .2s ease, background .2s ease;
}

.product-image-slider:hover .quick-add-simple {
  opacity: 1;
  visibility: visible;
  pointer-events: all;
  transform: translateY(0);
}

.quick-add-simple__icon svg { 
  width: 27px; 
  height: 31px;
  transition: transform .2s ease;
}

.quick-add-simple__text {
  font-size: 16px;
  white-space: nowrap;
  text-transform: uppercase;
  max-width: 0;
  overflow: hidden;
  opacity: 0;
  color: rgba(114, 149, 187, 1);
  transition: max-width .25s ease, opacity .2s ease;
}

.quick-add-simple:hover .quick-add-simple__text {
  max-width: fit-content;
  opacity: 1;
}

.quick-add-simple.adding {
  background: #f0f0f0;
}

.quick-add-simple.adding .quick-add-simple__icon svg {
  animation: spin 0.6s linear infinite;
}

.quick-add-simple.added {
  background: #4caf50;
  border-color: #4caf50;
  color: white;
}

.quick-add-simple.added svg {
  fill: white;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.quick-add-fly {
  position: fixed;
  z-index: 1000;
  transition: transform 0.6s cubic-bezier(0.4,0,0.2,1), opacity 0.6s ease;
  pointer-events: none;
}
</style>

<script>
document.addEventListener('click', async function(e) {
  const button = e.target.closest('.quick-add-simple');
  if (!button) return;

  e.preventDefault();
  e.stopImmediatePropagation();

  if (button.disabled) return;
  button.disabled = true;
  button.classList.add('adding');

  const handle = button.dataset.productHandle;
  if (!handle) return;

  try {
    // Get product JSON
    const productData = await fetch(`/products/${handle}.js`).then(r => r.json());
    const variant = productData.variants.find(v => v.available);
    if (!variant) { 
      button.disabled = false;
      button.classList.remove('adding');
      return;
    }

    // Get product image for animation
    const imgEl = button.closest('.product-image-slider')?.querySelector('img');
    let clone;
    if (imgEl) {
      clone = imgEl.cloneNode(true);
      clone.classList.add('quick-add-fly');
      clone.style.width = imgEl.offsetWidth + 'px';
      clone.style.height = imgEl.offsetHeight + 'px';
      const rect = imgEl.getBoundingClientRect();
      clone.style.top = rect.top + 'px';
      clone.style.left = rect.left + 'px';
      document.body.appendChild(clone);
    }

    // Add to cart
    const addResponse = await fetch('/cart/add.js', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ 
        items: [{
          id: variant.id,
          quantity: 1
        }]
      })
    });

    if (!addResponse.ok) throw new Error('Failed to add to cart');

    // Animate fly-to-cart
    if (clone) {
      const cartIcon = document.querySelector('.header__icon--cart, .cart-count-bubble, #cart-icon-bubble, [href="/cart"]');
      if (cartIcon) {
        const rect = cartIcon.getBoundingClientRect();
        requestAnimationFrame(() => {
          clone.style.transform = `translate(${rect.left - clone.getBoundingClientRect().left}px, ${rect.top - clone.getBoundingClientRect().top}px) scale(0.2)`;
          clone.style.opacity = '0';
        });
        setTimeout(() => clone.remove(), 600);
      } else {
        clone.remove();
      }
    }

    // Get updated cart
    const cart = await fetch('/cart.js').then(r => r.json());

    // Force update cart count - more aggressive approach
    const forceUpdateCartCount = (count) => {
      // All possible cart count selectors
      const selectors = [
        'cart-count-bubble',
        '.cart-count-bubble',
        '#cart-icon-bubble',
        '.header__cart-count',
        '[data-cart-count]',
        '.cart-count',
        '#CartCount',
        '.CartCount',
        'cart-drawer .cart-count-bubble'
      ];
      
      selectors.forEach(selector => {
        const elements = document.querySelectorAll(selector);
        elements.forEach(el => {
          // Update text in all possible ways
          if (el.textContent !== undefined) el.textContent = count;
          if (el.innerText !== undefined) el.innerText = count;
          
          // Update attributes
          if (el.hasAttribute('data-cart-count')) {
            el.setAttribute('data-cart-count', count);
          }
          
          // Show/hide visibility
          if (count > 0) {
            el.classList.remove('hidden');
            el.removeAttribute('hidden');
            el.style.display = '';
            el.style.visibility = 'visible';
          }
        });
      });
      
      // Force update using MutationObserver trigger
      const cartCountBubble = document.querySelector('.cart-count-bubble');
      if (cartCountBubble) {
        cartCountBubble.setAttribute('data-count', count);
      }
    };

    // Update immediately
    forceUpdateCartCount(cart.item_count);

    // Trigger theme's native cart update mechanisms
    fetch(window.Shopify.routes.root + 'cart.js')
      .then(response => response.json())
      .then(cartData => {
        // Dispatch multiple event types for compatibility
        const events = [
          new CustomEvent('cart:refresh', { bubbles: true, detail: { cart: cartData } }),
          new CustomEvent('cart:updated', { bubbles: true, detail: { cart: cartData } }),
          new CustomEvent('cart:change', { bubbles: true, detail: { cart: cartData } }),
          new Event('cart:build', { bubbles: true })
        ];
        
        events.forEach(event => {
          document.documentElement.dispatchEvent(event);
          document.body.dispatchEvent(event);
          document.dispatchEvent(event);
        });

        // Update again after events
        setTimeout(() => forceUpdateCartCount(cartData.item_count), 50);
      });

    // Handle cart drawer/notification
    setTimeout(() => {
      const drawer = document.querySelector('cart-drawer');
      const notification = document.querySelector('cart-notification');
      
      if (drawer) {
        if (typeof drawer.renderContents === 'function') {
          drawer.renderContents(cart);
        }
        if (typeof drawer.open === 'function') {
          drawer.open();
        }
      } else if (notification) {
        if (typeof notification.renderContents === 'function') {
          notification.renderContents(cart);
        }
        if (typeof notification.open === 'function') {
          notification.open();
        }
      }
    }, 100);

    // Visual feedback
    button.classList.remove('adding');
    button.classList.add('added');
    
    setTimeout(() => {
      button.classList.remove('added');
      button.disabled = false;
    }, 1500);

  } catch(err) {
    console.error('Quick add failed:', err);
    button.classList.remove('adding');
    button.disabled = false;
    alert('Failed to add product to cart. Please try again.');
  }
});
</script>
